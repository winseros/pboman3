<?xml version="1.0" encoding="UTF-8"?>
<?define UpgradeCode="A6EA91AB-5F50-4010-BC8B-C5A21885C695"?>
<?define Author="Nikita Kobzev"?>
<?define AppName="PBO Manager"?>
<?define RegAppId="pboman3"?>
<?define RegProgId="pboman3_pbo"?>
<?define RegClsId="{dd2a27fa-7c7f-4b50-9b54-836af42fb64d}"?>

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
    <Package Manufacturer="$(var.Author)" Name="PBO Manager" Version="$(var.ProductVersion)"
             UpgradeCode="$(var.UpgradeCode)" Scope="perMachine">

        <Icon Id="ICON_PBOM" SourceFile="$(var.ArtifactsFolder)pbom.exe"/>
        <Property Id="ARPPRODUCTICON" Value="ICON_PBOM" />
        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."/>
        <MediaTemplate EmbedCab="yes"/>

        <util:QueryNativeMachine/>

        <Property Id="PBOMCPPREDISTEXISTS">
            <DirectorySearch Id="VcRedistDir" Path="[System64Folder]" Depth="0">
                <FileSearch Id="VcRedistFile" Name="vcruntime140.dll"/>
            </DirectorySearch>
        </Property>

        <Launch Condition="WIX_NATIVE_MACHINE = 34404" Message="Must run only on an x64 machine!"/>
        <Launch Condition="Installed OR (VersionNT64 >= 603)"
                Message="This application is only supported on Windows 10, or higher."/>
        <Launch Condition="Installed OR PBOMCPPREDISTEXISTS"
                Message="This application requires Microsoft Visual C++ Redistributable 2015 or higher. Please install it, then run this installer again."/>

        <Property Id="PbomInstallScope" Value="machine"/>
        <WixVariable Id="WixUILicenseRtf" Value="$(sys.SOURCEFILEDIR)..\LICENSE.rtf" />
        <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" ExtendedPathValidation="yes"/>

        <UIRef Id="PBOMan_Dialogs"/>
        <UIRef Id="PBOMan_UiSequence"/>

        <FeatureRef Id="F_MainFiles"/>

        <InstallExecuteSequence>
            <ScheduleReboot After="InstallFinalize"/>
        </InstallExecuteSequence>

        <StandardDirectory Id="TARGETDIR">
            <Directory Id="INSTALLFOLDER" Name="$(var.AppName)"/>
        </StandardDirectory>
    </Package>

    <Fragment>
        <DirectoryRef Id="INSTALLFOLDER">
            <Directory Id="D_ImageFormats" Name="ImageFormats"/>
            <Directory Id="D_Platforms" Name="Platforms"/>
            <Directory Id="D_Styles" Name="Styles"/>
            <Directory Id="D_Tls" Name="Tls"/>
        </DirectoryRef>

        <ComponentGroup Id="CG_MainFiles">
            <ComponentRef Id="C_MainFiles__pboe.dll"/>
            <ComponentRef Id="C_MainFiles__pbom.exe"/>
            <ComponentRef Id="C_MainFiles__pboc.exe"/>
            <ComponentRef Id="C_MainFiles__Qt6Core.dll"/>
            <ComponentRef Id="C_MainFiles__Qt6Gui.dll"/>
            <ComponentRef Id="C_MainFiles__Qt6Widgets.dll"/>
            <ComponentRef Id="C_MainFiles__Qt6Network.dll"/>
            <ComponentRef Id="C_MainFiles__ImageFormats__qico.dll"/>
            <ComponentRef Id="C_MainFiles__Platforms__qwindows.dll"/>
            <ComponentRef Id="C_MainFiles__Styles__qmodernwindowsstyle.dll"/>
            <ComponentRef Id="C_MainFiles__Tls__qcertonlybackend.dll"/>
            <ComponentRef Id="C_MainFiles__Tls__qopensslbackend.dll"/>
            <ComponentRef Id="C_MainFiles__Tls__qschannelbackend.dll"/>
        </ComponentGroup>
    </Fragment>

    <Fragment>
        <Feature Id="F_MainFiles" Title="$(var.AppName)" Level="1" InstallDefault="local" AllowAbsent="no"
                 Description="The main application files." AllowAdvertise="no">
            <ComponentGroupRef Id="CG_MainFiles"/>

            <FeatureRef Id="F_ShellExtension"/>
            <FeatureRef Id="F_ProgramMenuShortcut"/>
            <FeatureRef Id="F_DesktopShortcut"/>
            <FeatureRef Id="F_EnvVariables"/>
        </Feature>

        <DirectoryRef Id="INSTALLFOLDER">
            <Component Id="C_MainFiles__pboe.dll" Guid="08AE24AD-11EE-481E-8E38-2A30968FA898" Bitness="always64">
                <File Id="F_MainFiles__pboe.dll" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)pboe.dll"/>
            </Component>

            <Component Id="C_MainFiles__pbom.exe" Guid="7FC3F37E-AE6D-4BA0-8677-3C056F13519C" Bitness="always64">
                <File Id="F_MainFiles__pbom.exe" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)pbom.exe"/>

                <ProgId Id="$(var.RegProgId)" Icon="F_MainFiles__pbom.exe" IconIndex="1"
                        Description="[ProductName] file">
                    <Extension Id="pbo">
                        <Verb Id="open" Command="Open" TargetFile="F_MainFiles__pbom.exe"
                              Argument="open &quot;%1&quot;"/>
                    </Extension>
                </ProgId>
            </Component>

            <Component Id="C_MainFiles__pboc.exe" Guid="E7F4C6E0-52EA-42DF-A47F-73B39FBFB36E" Bitness="always64">
                <File Id="F_MainFiles__pboc.exe" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)pboc.exe"/>
            </Component>

            <Component Id="C_MainFiles__Qt6Core.dll" Guid="1D77E778-A132-44DA-BB2C-1A6D275DCB45" Bitness="always64">
                <File Id="F_MainFiles__Qt6Core.dll" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)Qt6Core.dll"/>
            </Component>

            <Component Id="C_MainFiles__Qt6Gui.dll" Guid="3DECC976-0D8C-429A-B322-874F782F1094" Bitness="always64">
                <File Id="F_MainFiles__Qt6Gui.dll" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)Qt6Gui.dll"/>
            </Component>

            <Component Id="C_MainFiles__Qt6Widgets.dll" Guid="AC56AA6E-8B4B-4DD9-90E6-392F36296D37" Bitness="always64">
                <File Id="F_MainFiles__Qt6Widgets.dll" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)Qt6Widgets.dll"/>
            </Component>

            <Component Id="C_MainFiles__Qt6Network.dll" Guid="789B6BB3-0304-4CEE-A675-D250A610F1BE" Bitness="always64">
                <File Id="F_MainFiles__Qt6Network.dll" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)Qt6Network.dll"/>
            </Component>
        </DirectoryRef>

        <DirectoryRef Id="D_ImageFormats">
            <Component Id="C_MainFiles__ImageFormats__qico.dll" Guid="C57F8095-A82C-4F3A-8612-A0EBED935FA4" Bitness="always64">
                <File Id="F_MainFiles__ImageFormats__qico.dll" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)ImageFormats\qico.dll"/>
            </Component>
        </DirectoryRef>

        <DirectoryRef Id="D_Platforms">
            <Component Id="C_MainFiles__Platforms__qwindows.dll" Guid="6DCE46A8-8B54-4EE6-BC69-7B22974E61E2">
                <File Id="F_MainFiles__Platforms__qwindows.dll" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)Platforms\qwindows.dll"/>
            </Component>
        </DirectoryRef>

        <DirectoryRef Id="D_Styles">
            <Component Id="C_MainFiles__Styles__qmodernwindowsstyle.dll" Guid="720D10E0-AEA8-47E1-9A5C-9EB49C4CCCDD">
                <File Id="F_MainFiles__Styles__qmodernwindowsstyle.dll" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)Styles\qmodernwindowsstyle.dll"/>
            </Component>
        </DirectoryRef>

        <DirectoryRef Id="D_Tls">
            <Component Id="C_MainFiles__Tls__qcertonlybackend.dll" Guid="0A8B6A2B-8704-454F-81F7-19812CC980DB">
                <File Id="F_MainFiles__Tls__qcertonlybackend.dll" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)Tls\qcertonlybackend.dll"/>
            </Component>
            <Component Id="C_MainFiles__Tls__qopensslbackend.dll" Guid="864E2C73-369B-42AF-88E4-989C858C04E2">
                <File Id="F_MainFiles__Tls__qopensslbackend.dll" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)Tls\qopensslbackend.dll"/>
            </Component>
            <Component Id="C_MainFiles__Tls__qschannelbackend.dll" Guid="9DC559C3-3109-4EFE-8C42-87F0B9678E9C">
                <File Id="F_MainFiles__Tls__qschannelbackend.dll" KeyPath="yes" Vital="yes"
                      Source="$(var.ArtifactsFolder)Tls\qschannelbackend.dll"/>
            </Component>
        </DirectoryRef>
    </Fragment>

    <Fragment>
        <Feature Id="F_ShellExtension" Title="Windows Context Menu extension" Level="1" InstallDefault="local" AllowAbsent="yes"
                 Description="$(var.AppName) items in the Windows Explorer Context Menu."  AllowAdvertise="no">
            <ComponentGroupRef Id="CG_ShellExtension"/>
        </Feature>

        <ComponentGroup Id="CG_ShellExtension">
            <Component Id="C_Registry_1">
                <RegistryValue Root="HKCR"
                               Key="$(var.RegProgId)\Shell\$(var.RegAppId).menu"
                               Value="$(var.RegClsId)" Name="ExplorerCommandHandler"
                               Type="string" KeyPath="yes"/>

                <Class Id="$(var.RegClsId)" Context="InprocServer32" Description="[ProductName] shell extension"
                       Server="F_MainFiles__pboe.dll" ThreadingModel="apartment" Advertise="no" >
                </Class>
            </Component>
            <Component Id="C_Registry_2">
                <RegistryValue Root="HKCR"
                               Key="$(var.RegProgId)\Shell\$(var.RegAppId).menu"
                               Value="$(var.AppName)" Type="string" KeyPath="yes"/>
            </Component>
            <Component Id="C_Registry_3">
                <RegistryValue Root="HKCR"
                               Key="$(var.RegProgId)\Shell\$(var.RegAppId).menu"
                               Value="" Name="NeverDefault" Type="string" KeyPath="yes"/>
            </Component>
            <Component Id="C_Registry_4">
                <RegistryValue Root="HKCR"
                               Key="$(var.RegProgId)"
                               Name="Path"
                               Value="[INSTALLFOLDER]pbom.exe" Type="string"
                               KeyPath="yes"/>
            </Component>
            <Component Id="C_Registry_5">
                <RegistryValue Root="HKCR"
                               Key="Directory\Shell\$(var.RegAppId).menu"
                               Value="$(var.RegClsId)" Name="ExplorerCommandHandler"
                               Type="string" KeyPath="yes"/>
            </Component>
            <Component Id="C_Registry_6">
                <RegistryValue Root="HKCR"
                               Key="Directory\Shell\$(var.RegAppId).menu"
                               Value="$(var.AppName)" Type="string" KeyPath="yes"/>
            </Component>
            <Component Id="C_Registry_7">
                <RegistryValue Root="HKCR"
                               Key="Directory\Shell\$(var.RegAppId).menu"
                               Value="" Name="NeverDefault" Type="string" KeyPath="yes"/>
            </Component>
        </ComponentGroup>
    </Fragment>

    <Fragment>
        <Feature Id="F_ProgramMenuShortcut" Title="Start Menu shortcut" Level="1" InstallDefault="local"
                 Description="$(var.AppName) shortcut in the Windows Start Menu."  AllowAdvertise="no">
            <ComponentRef Id="C_ProgramMenuShortcut" />
        </Feature>

        <StandardDirectory Id="ProgramMenuFolder">
            <Directory Id="ApplicationProgramsFolder" Name="$(var.AppName)">
                <Component Id="C_ProgramMenuShortcut" Guid="D7DB1D47-84F0-4208-A747-7F75B08D9D8F">
                    <Shortcut Id="S_ProgramMenuShortcut" Name="$(var.AppName)"
                              Description="Utility to open/pack/unpack ArmA PBO files"
                              Target="[INSTALLFOLDER]pbom.exe"
                              WorkingDirectory="INSTALLFOLDER" />
                    <RemoveFolder Id="RF_ProgramMenuShortcut" Directory="ApplicationProgramsFolder"
                                  On="uninstall" />
                    <RegistryValue KeyPath="yes" Root="HKCU" Key="Software\$(var.RegAppId)" Name="ProgramMenu"
                                   Value="1" Type="integer"/>
                </Component>
            </Directory>
        </StandardDirectory>
    </Fragment>

    <Fragment>
        <Feature Id="F_DesktopShortcut" Title="Desktop shortcut" Level="1" InstallDefault="local"
                 Description="$(var.AppName) shortcut on the desktop." AllowAdvertise="no">
            <ComponentRef Id="C_DesktopShortcut" />
        </Feature>

        <StandardDirectory Id="DesktopFolder">
            <Component Id="C_DesktopShortcut" Guid="886844F8-FF22-4F40-8332-FEDE21F42928">
                <Shortcut Id="S_DesktopShortcut" Name="$(var.AppName)"
                          Description="Utility to open/pack/unpack ArmA PBO files"
                          Target="[INSTALLFOLDER]pbom.exe"
                          WorkingDirectory="INSTALLFOLDER" />
                <RegistryValue KeyPath="yes" Root="HKCU" Key="Software\$(var.RegAppId)" Name="Desktop"
                               Value="1" Type="integer"/>
            </Component>
        </StandardDirectory>
    </Fragment>

    <Fragment>
        <Feature Id="F_EnvVariables" Title="Add to PATH" Level="2"
                 Description="Add $(var.AppName) to the system PATH. Useful for script automation."
                 AllowAdvertise="no">
            <Component Id="C_EnvVariablesUser" Guid="b5ec4b4e-9dbb-4189-9660-55611c800a51" Condition="NOT ALLUSERS">
                <Environment Id="EV_PathUser" Name="PATH" Action="set" Value="[INSTALLFOLDER]" Part="last" System="no"/>
            </Component>
            <Component Id="C_EnvVariablesSystem" Guid="b5ec4b4e-9dbb-4189-9660-55611c800a52" Condition="ALLUSERS">
                <Environment Id="EV_PathSystem" Name="PATH" Action="set" Value="[INSTALLFOLDER]" Part="last" System="yes"/>
            </Component>
        </Feature>
    </Fragment>

    <Fragment>
        <CustomAction Id="PbomSetDefaultUserFolder" Property="PbomUserFolder"
                      Value="[LocalAppDataFolder]$(var.AppName)\" Execute="immediate"/>
        <CustomAction Id="PbomSetDefaultMachineFolder" Property="PbomMachineFolder"
                      Value="[ProgramFiles64Folder]$(var.AppName)\" Execute="immediate"/>
        <CustomAction Id="PbomSetUserFolder" Property="INSTALLFOLDER" Value="[PbomUserFolder]"
                      Execute="immediate"/>
        <CustomAction Id="PbomSetMachineFolder" Property="INSTALLFOLDER" Value="[PbomMachineFolder]"
                      Execute="immediate"/>

        <InstallExecuteSequence>
            <Custom Action="PbomSetDefaultUserFolder" Before="CostFinalize"/>
            <Custom Action="PbomSetDefaultMachineFolder" After="PbomSetDefaultUserFolder"/>
            <Custom Action="PbomSetUserFolder" After="PbomSetDefaultMachineFolder"
                    Condition="ACTION=&quot;INSTALL&quot; AND NOT INSTALLFOLDER AND (NOT ALLUSERS OR (ALLUSERS=2 AND (NOT Privileged)))"/>
            <Custom Action="PbomSetMachineFolder" After="PbomSetUserFolder"
                    Condition="ACTION=&quot;INSTALL&quot; AND NOT INSTALLFOLDER AND (ALLUSERS=1 OR (ALLUSERS=2 AND Privileged))"/>
        </InstallExecuteSequence>
        <InstallUISequence>
            <Custom Action="PbomSetDefaultUserFolder" Before="CostFinalize"/>
            <Custom Action="PbomSetDefaultMachineFolder" After="PbomSetDefaultUserFolder"/>
            <Custom Action="PbomSetUserFolder" After="PbomSetDefaultMachineFolder"
                    Condition="ACTION=&quot;INSTALL&quot; AND NOT INSTALLFOLDER AND (NOT ALLUSERS OR (ALLUSERS=2 AND (NOT Privileged)))"/>
            <Custom Action="PbomSetMachineFolder" After="PbomSetUserFolder"
                    Condition="ACTION=&quot;INSTALL&quot; AND NOT INSTALLFOLDER AND (ALLUSERS=1 OR (ALLUSERS=2 AND Privileged))"/>
        </InstallUISequence>

        <UI Id="PBOMan_UiSequence">
            <Publish Dialog="LicenseAgreementDlg" Control="Next" Event="NewDialog" Value="MachineOrUserDlg"
                     Condition="LicenseAccepted = &quot;1&quot;"/>

            <Publish Dialog="MachineOrUserDlg" Control="Back" Event="NewDialog" Value="LicenseAgreementDlg"/>
            <Publish Dialog="MachineOrUserDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg"/>
            <Publish Dialog="MachineOrUserDlg" Control="Next" Property="ALLUSERS" Value="{}" Condition="PbomInstallScope = &quot;user&quot;"/>
            <Publish Dialog="MachineOrUserDlg" Control="Next" Property="MSIINSTALLPERUSER" Value="1" Condition="PbomInstallScope = &quot;user&quot;"/>
            <Publish Dialog="MachineOrUserDlg" Control="Next" Property="ALLUSERS" Value="2" Condition="PbomInstallScope = &quot;machine&quot;"/>
            <Publish Dialog="MachineOrUserDlg" Control="Next" Property="MSIINSTALLPERUSER" Value="{}" Condition="PbomInstallScope = &quot;machine&quot;"/>
            <Publish Dialog="MachineOrUserDlg" Control="Next" Property="INSTALLFOLDER" Value="[PbomUserFolder]" Condition="PbomInstallScope = &quot;user&quot;"/>
            <Publish Dialog="MachineOrUserDlg" Control="Next" Property="INSTALLFOLDER" Value="[PbomMachineFolder]" Condition="PbomInstallScope = &quot;machine&quot;"/>
            <Publish Dialog="MachineOrUserDlg" Control="Next" Event="DoAction" Value="FindRelatedProducts" Order="10"/>

            <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="MachineOrUserDlg"/>
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="FeaturesDlg" Order="4" Condition="WIXUI_INSTALLDIR_VALID=&quot;1&quot;" />

            <Publish Dialog="FeaturesDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg" />
            <Publish Dialog="FeaturesDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg" />
        </UI>
    </Fragment>

    <Fragment>
        <UI Id="PBOMan_Dialogs">
            <Dialog Id="MachineOrUserDlg" Width="370" Height="270" Title="!(loc.InstallScopeDlg_Title)" KeepModeless="yes">
                <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="!(loc.InstallScopeDlgBannerBitmap)" />
                <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="373" Height="0" />
                <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="373" Height="0" />
                <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="20" Transparent="yes" NoPrefix="yes" Text="!(loc.InstallScopeDlgDescription)" />
                <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.InstallScopeDlgTitle)" />
                <Control Id="BothScopes" Type="RadioButtonGroup" X="20" Y="55" Width="330" Height="120" Property="PbomInstallScope">
                    <RadioButtonGroup Property="PbomInstallScope">
                        <RadioButton Value="user" X="0" Y="0" Width="295" Height="16" Text="!(loc.InstallScopeDlgPerUser)" />
                        <RadioButton Value="machine" X="0" Y="60" Width="295" Height="16" Text="!(loc.InstallScopeDlgPerMachine)" />
                    </RadioButtonGroup>
                </Control>
                <Control Id="PerUserDescription" Type="Text" X="33" Y="70" Width="300" Height="36" NoPrefix="yes" Text="!(loc.InstallScopeDlgPerUserDescription)"  />
                <Control Id="PerMachineDescription" Type="Text" X="33" Y="131" Width="300" Height="36" NoPrefix="yes" Text="!(loc.InstallScopeDlgPerMachineDescription)" />
                <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="!(loc.WixUIBack)" />
                <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="!(loc.WixUINext)" />
                <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="!(loc.WixUICancel)">
                    <Publish Event="SpawnDialog" Value="CancelDlg" />
                </Control>
            </Dialog>
        </UI>
    </Fragment>
</Wix>